# Alembic Database Migrations

Alembic is configured to manage database schema changes for this project.

## Setup Complete ✓

- Database URL is loaded from `.env` file
- Models are imported from `db.models.models`
- ENUM type comparison is enabled

## Common Commands

### 1. Create a New Migration (Auto-generate)

Alembic will compare your SQLAlchemy models with the current database and create a migration:

```bash
# From project root
alembic revision --autogenerate -m "add enum types"
```

### 2. View Pending Migrations

```bash
alembic current  # Show current revision
alembic history  # Show all revisions
alembic heads    # Show the most recent revision
```

### 3. Run Migrations (Upgrade)

```bash
# Upgrade to latest
alembic upgrade head

# Upgrade one revision at a time
alembic upgrade +1

# Upgrade to specific revision
alembic upgrade <revision_id>
```

### 4. Rollback Migrations (Downgrade)

```bash
# Downgrade one revision
alembic downgrade -1

# Downgrade to specific revision
alembic downgrade <revision_id>

# Downgrade all (back to empty database)
alembic downgrade base
```

### 5. Create Empty Migration (Manual)

For complex migrations that need custom SQL:

```bash
alembic revision -m "custom migration"
```

Then edit the generated file in `alembic/versions/`.

## Example Workflow

### Creating and Running Your First Migration

```bash
# 1. Make sure your .env file has database credentials
# POSTGRES_USER=...
# POSTGRES_PASSWORD=...
# POSTGRES_HOST=localhost
# POSTGRES_PORT=5432
# POSTGRES_DB=...

# 2. Generate migration based on model changes
alembic revision --autogenerate -m "add worker_status and job_type enums"

# 3. Review the generated migration in alembic/versions/
# Check that it looks correct!

# 4. Run the migration
alembic upgrade head

# 5. Verify in database
# psql -U your_user -d your_db -c "\dT"  # List ENUM types
```

## Important Notes

### ENUMs in PostgreSQL

- Alembic creates PostgreSQL ENUM types automatically
- When you add new values to an enum, you may need to write custom migration:

```python
def upgrade():
    # Add new enum value
    op.execute("ALTER TYPE worker_status ADD VALUE 'retrying'")
```

### Autogenerate Limitations

Alembic autogenerate can detect:
- ✅ New tables
- ✅ New columns
- ✅ Column type changes
- ✅ New indexes
- ✅ ENUM type changes (with compare_type=True)

Alembic autogenerate CANNOT detect:
- ❌ Table/column renames (shows as drop + create)
- ❌ Changes to ENUM values (need manual migration)

### Migration File Location

Migrations are stored in: `alembic/versions/`

Each migration has:
- **Revision ID**: Unique identifier (e.g., `a1b2c3d4e5f6`)
- **Down revision**: Previous migration it depends on
- **upgrade()**: Apply changes
- **downgrade()**: Revert changes

## Troubleshooting

### "Target database is not up to date"

```bash
# Check current version
alembic current

# If it says no version, stamp the database with current revision
alembic stamp head
```

### "Can't locate revision identified by..."

Your database has a revision that doesn't exist in your code:

```bash
# Reset to base
alembic stamp base

# Then upgrade
alembic upgrade head
```

### Import Errors

If you get import errors, make sure you're running from project root and environment is activated.

## Best Practices

1. **Review generated migrations** - Always check autogenerated code
2. **Test migrations** - Test both upgrade and downgrade
3. **Version control** - Commit migration files to git
4. **One change per migration** - Keep migrations focused
5. **Don't edit old migrations** - Create new ones instead

## For Your Current ENUMs Change

Since you've already updated your models to use ENUMs, run:

```bash
# Generate the migration
alembic revision --autogenerate -m "convert text columns to enum types"

# Review the generated file, then apply it
alembic upgrade head
```

This will create the necessary ENUM types and convert your columns.

